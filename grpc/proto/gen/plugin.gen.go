package main

import (
	"google.golang.org/protobuf/compiler/protogen"
)

func genHeader(g *protogen.GeneratedFile, file *protogen.File) {
	g.P("// Code generated by protoc-gen-go-grpc-x. DO NOT EDIT.")
	g.P("// versions:")
	g.P("// - protoc-gen-go-grpc-x v1.0.0")
	g.P("// source: ", file.Desc.Path())
	g.P()
	g.P("package ", file.GoPackageName)
	g.P()
}

func genFunction(g *protogen.GeneratedFile, file *protogen.File) {
	for _, service := range file.Services {
		sn := service.GoName

		g.P("type ", getXService(sn), " struct {")
		g.P("\t", ableField(), " *", xcontrolPackage.Ident("SwitchButton"))
		g.P("\t", connField(), " *", grpcPackage.Ident("ClientConn"))
		g.P()
		g.P("\t", lowerFirst(getXServiceClient(sn)), " *", getXServiceClient(sn))
		for _, m := range service.Methods {
			if m.Desc.IsStreamingClient() || m.Desc.IsStreamingServer() { // stream
				g.P("\t", lowerFirst(getXStreamServiceMethodClient(sn, m.GoName)), " ", getXStreamServiceMethodClient(sn, m.GoName))
			}
		}
		g.P("}")
		g.P()
		g.P("func ", getNewXService(sn), "(target string) (*", getXService(sn), ", error) {")
		g.P("\t", lowerFirst(sn), " := &", getXService(sn), "{")
		g.P("\t\t", ableField(), ": ", xcontrolPackage.Ident("NewSwitchButton"), "(true),")
		g.P("\t}")
		g.P("\tvar err error")
		g.P("\t", lowerFirst(sn), ".", connField(), ", err = ", lowerFirst(sn), ".dial(target)")
		g.P("\tif err != nil {")
		g.P("\t\treturn nil, ", errorsPackage.Ident("WithMessage"), "(err, ", xruntimePackage.Ident("Location"), "())")
		g.P("\t}")
		g.P("\t", lowerFirst(sn), ".", lowerFirst(getXServiceClient(sn)),
			" = ", getNewXServiceClient(sn), "(", lowerFirst(sn), ".", connField(), ")")
		for _, m := range service.Methods {
			if m.Desc.IsStreamingClient() || m.Desc.IsStreamingServer() { // stream
				g.P("\t{")
				g.P("\t\t", lowerFirst(sn), ".", lowerFirst(getXStreamServiceMethodClient(sn, m.GoName)),
					".", getService_MethodClient(sn, m.GoName), " , err = ", lowerFirst(sn), ".",
					lowerFirst(getXServiceClient(sn)), ".", m.GoName, "(", contextPackage.Ident("Background"), "())")
				g.P("\t\tif err != nil {")
				g.P("\t\t\t_= ", lowerFirst(sn), ".Stop()")
				g.P("\t\t\treturn nil, ", errorsPackage.Ident("WithMessage"), "(err, ", xruntimePackage.Ident("Location"), "())")
				g.P("\t\t}")
				g.P("\t}")
			}
		}
		g.P("\treturn ", lowerFirst(sn), ", nil")
		g.P("\t}")
		g.P()

		g.P("func (p *", getXService(sn), ") GetClientConn() *", grpcPackage.Ident("ClientConn"), " {")
		g.P("\treturn p.", connField())
		g.P("}")
		g.P()

		g.P("func (p *", getXService(sn), ") Disabled() {")
		g.P("\tp.", ableField(), ".Off()")
		g.P("}")
		g.P()

		g.P("func (p *", getXService(sn), ") Available() bool {")
		g.P("\treturn p.", ableField(), ".IsOn()")
		g.P("}")
		g.P()

		g.P("func (p *", getXService(sn), ") Start() error {")
		for _, m := range service.Methods {
			if m.Desc.IsStreamingClient() || m.Desc.IsStreamingServer() { // stream
				g.P("\t_=p.", lowerFirst(getXStreamServiceMethodClient(sn, m.GoName)), ".Start()")
			}
		}
		g.P("\treturn nil")
		g.P("}")
		g.P()

		g.P("func (p *", getXService(sn), ") Stop() error {")

		g.P("\tvar err error")
		for _, m := range service.Methods {
			if m.Desc.IsStreamingClient() || m.Desc.IsStreamingServer() { // stream
				g.P("\terr = p.", lowerFirst(getXStreamServiceMethodClient(sn, m.GoName)),
					".", getService_MethodClient(sn, m.GoName), ".CloseSend()")
				g.P("\tif err != nil {")
				g.P("\t\treturn ", errorsPackage.Ident("WithMessage"), "(err, ", xruntimePackage.Ident("Location"), "())")
				g.P("\t}")
			}
		}
		g.P("\tif p.", connField(), " != nil {")
		g.P("\t\terr = p.", connField(), ".Close()")
		g.P("\t\tif err != nil {")
		g.P("\t\t\treturn ", errorsPackage.Ident("WithMessage"), "(err, ", xruntimePackage.Ident("Location"), "())")
		g.P("\t\t}")
		g.P("\t}")
		g.P("\treturn nil")
		g.P("}")
		g.P()

		g.P("func (p *", getXService(sn), ") dial(target string, opts ...", grpcPackage.Ident("DialOption"), ") (*", grpcPackage.Ident("ClientConn"), ", error) {")
		g.P("\topts = []", grpcPackage.Ident("DialOption"), "{")
		g.P("\t\t", grpcPackage.Ident("WithTransportCredentials"), "(", insecurePackage.Ident("NewCredentials"), "()),")
		g.P("\t\t", grpcPackage.Ident("WithBlock"), "(),")
		g.P("\t\t", grpcPackage.Ident("WithTimeout"), "(", xgrpcutilPackage.Ident("ConnectTimeoutDurationDefault"), "),")
		g.P("\t\t", grpcPackage.Ident("WithChainUnaryInterceptor"), "(")
		g.P("\t\t\t", xgrpcprotointerceptorPackage.Ident("TimeOutClientInterceptor"), "(),")
		g.P("\t\t\t", xgrpcprotointerceptorPackage.Ident("TraceClientInterceptor"), "(),")
		g.P("\t\t),")
		g.P("\t}")
		g.P("\t", connField(), ", err := ", grpcPackage.Ident("Dial"), "(target, opts...)")
		g.P("\tif err != nil {")
		g.P("\t\treturn nil, ", errorsPackage.Ident("WithMessage"), "(err, ", xruntimePackage.Ident("Location"), "())")
		g.P("\t}")
		g.P("\treturn ", connField(), ", nil")
		g.P("}")
		g.P()
	}

}
